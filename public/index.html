<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Luna Web Chat</title>
  <style>
    body { background:#0e0e12; color:#fff; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; padding:16px; }
    .chat { max-width:600px; width:100%; background:#191923; border-radius:16px; padding:12px; display:flex; flex-direction:column; gap:8px; height:70vh; overflow-y:auto; }
    .bubble { padding:10px; border-radius:12px; max-width:70%; }
    .user { align-self:flex-end; background:#2a2a36; }
    .bot { align-self:flex-start; background:#252530; }
    .input { margin-top:12px; display:flex; gap:8px; width:100%; max-width:600px; }
    .input input { flex:1; padding:10px; border-radius:8px; border:none; }
    .input button { padding:10px 14px; border:none; border-radius:8px; background:#7c5cff; color:#fff; }
  </style>
</head>
<body>
  <h1>ðŸŒ™ Luna</h1>
  <img id="avatar" src="luna1.png" width="80" style="border-radius:50%; margin-bottom:10px;" />
  <div class="chat" id="chat"></div>
  <div class="input">
    <input id="msg" placeholder="Type message..." />
    <button id="sendBtn">Send</button>
  </div>

<script>
const chat = document.getElementById("chat");
const avatar = document.getElementById("avatar");
const input = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");

function bubble(text, who="bot") {
  const div = document.createElement("div");
  div.className = `bubble ${who}`;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function send() {
  const text = input.value.trim();
  if (!text) return;
  bubble(text, "user");
  input.value = "";

  const typing = document.createElement("div");
  typing.className = "bubble bot";
  typing.textContent = "â€¦";
  chat.appendChild(typing);

  try {
    const r = await fetch("/api/chat", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ message: text })
    });
    const data = await r.json();
    typing.remove();
    bubble(data.reply, "bot");

    if (data.expression) avatar.src = data.expression;

    // Play audio
    const v = await fetch("/api/voice", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ text: data.reply })
    });
    const blob = await v.blob();
    const url = URL.createObjectURL(blob);
    const audio = new Audio(url);
    audio.play();
  } catch(e) {
    typing.remove();
    bubble("Error: "+e.message, "bot");
  }
}

sendBtn.onclick = send;
input.addEventListener("keydown", e => { if (e.key==="Enter") send(); });
</script>
</body>
</html>
