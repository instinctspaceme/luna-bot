<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Luna Web Chat</title>
  <style>
    body { font-family: Arial, sans-serif; background: #1e1e1e; color: #eee; transition: background 0.5s; }
    #chat { max-width: 600px; margin: 20px auto; padding: 10px; background: #2c2c2c; border-radius: 8px; }
    .message { margin: 5px 0; padding: 8px; border-radius: 5px; }
    .user { background: #3a3a8a; text-align: right; }
    .bot { background: #444; text-align: left; display: flex; justify-content: space-between; align-items: center; }
    #inputArea { display: flex; margin-top: 10px; }
    #userInput { flex: 1; padding: 8px; }
    button { padding: 8px; background: #5c5cff; border: none; color: white; cursor: pointer; }
    .playBtn { margin-left: 10px; background: #4CAF50; border: none; padding: 5px; border-radius: 4px; cursor: pointer; color: white; }
    #settings { margin: 15px auto; max-width: 600px; padding: 10px; background: #2c2c2c; border-radius: 8px; }
    label { display: block; margin-top: 8px; }
    #micBtn { margin-left: 8px; background: red; }
  </style>
</head>
<body>
  <div id="chat"></div>

  <div id="inputArea">
    <input id="userInput" type="text" placeholder="Type or speak..."/>
    <button onclick="sendMessage()">Send</button>
    <button id="micBtn" onclick="toggleMic()">üé§</button>
  </div>

  <div id="settings">
    <h3>Personal Settings</h3>
    <label>Background:
      <select id="bgSelect" onchange="saveUserSettings()">
        <option value="default">Default</option>
        <option value="space">Space</option>
        <option value="forest">Forest</option>
        <option value="neon">Neon</option>
      </select>
    </label>
    <label>Voice Pitch: <input id="pitch" type="range" min="0.5" max="2" step="0.1" value="1" onchange="saveUserSettings()"> </label>
    <label>Voice Rate: <input id="rate" type="range" min="0.5" max="2" step="0.1" value="1" onchange="saveUserSettings()"> </label>
  </div>

  <script>
    let recognition;
    let isListening = false;

    if ("webkitSpeechRecognition" in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = "en-US";

      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById("userInput").value = transcript;
        sendMessage();
      };

      recognition.onerror = function(event) {
        console.error("Mic error:", event.error);
      };

      recognition.onend = function() {
        document.getElementById("micBtn").style.background = "red";
        isListening = false;
      };
    }

    function toggleMic() {
      if (!recognition) {
        alert("‚ùå Speech recognition not supported in this browser.");
        return;
      }
      if (!isListening) {
        recognition.start();
        document.getElementById("micBtn").style.background = "green";
        isListening = true;
      } else {
        recognition.stop();
        document.getElementById("micBtn").style.background = "red";
        isListening = false;
      }
    }

    function applyBackground(bg) {
      if (bg === "space") document.body.style.background = "url('https://picsum.photos/seed/space/1200/800') no-repeat center/cover";
      else if (bg === "forest") document.body.style.background = "url('https://picsum.photos/seed/forest/1200/800') no-repeat center/cover";
      else if (bg === "neon") document.body.style.background = "linear-gradient(135deg, #ff00ff, #00ffff)";
      else document.body.style.background = "#1e1e1e";
    }

    function saveUserSettings() {
      const bg = document.getElementById("bgSelect").value;
      const pitch = document.getElementById("pitch").value;
      const rate = document.getElementById("rate").value;
      localStorage.setItem("userSettings", JSON.stringify({ bg, pitch, rate }));
      applyBackground(bg);
    }

    function loadUserSettings() {
      const saved = localStorage.getItem("userSettings");
      if (saved) {
        const { bg, pitch, rate } = JSON.parse(saved);
        document.getElementById("bgSelect").value = bg;
        document.getElementById("pitch").value = pitch;
        document.getElementById("rate").value = rate;
        applyBackground(bg);
      }
    }

    function addMessage(sender, text, audioBase64 = null, pitch = 1, rate = 1) {
      const chat = document.getElementById("chat");
      const msg = document.createElement("div");
      msg.classList.add("message", sender);
      if (sender === "bot" && audioBase64) {
        msg.innerHTML = `<span>${text}</span>
          <button class="playBtn" onclick="playAudio('${audioBase64}', ${pitch}, ${rate})">üîä</button>`;
      } else msg.innerText = text;
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    }

    function playAudio(base64, pitch = 1, rate = 1) {
      const audio = new Audio("data:audio/mpeg;base64," + base64);
      audio.playbackRate = rate;
      audio.play();
    }

    async function sendMessage() {
      const input = document.getElementById("userInput");
      const message = input.value.trim();
      if (!message) return;
      addMessage("user", message);
      input.value = "";

      const settings = JSON.parse(localStorage.getItem("userSettings")) || { pitch: 1, rate: 1 };

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, pitch: settings.pitch, rate: settings.rate })
        });
        const data = await res.json();
        addMessage("bot", data.reply, data.audio, settings.pitch, settings.rate);
      } catch (err) {
        addMessage("bot", "‚ö†Ô∏è Error: " + err.message);
      }
    }

    loadUserSettings();
  </script>
</body>
</html>
