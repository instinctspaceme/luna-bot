<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Luna Web Chat</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background: #0f1115; color: #e6e6e6; margin: 0; }
    header { padding: 14px 16px; background:#151922; display:flex; gap:12px; align-items:center; }
    header h1 { margin:0; font-size:18px; font-weight:600; }
    main { max-width: 820px; margin: 0 auto; padding: 16px; }
    #chat { height: 60vh; border: 1px solid #2a2f3a; border-radius: 12px; padding: 12px; overflow-y: auto; background:#0b0d12; }
    .row { display:flex; margin: 8px 0; }
    .bubble { padding: 10px 12px; border-radius: 10px; max-width: 75%; }
    .me { justify-content: flex-end; }
    .me .bubble { background:#2962ff; color:#fff; border-bottom-right-radius: 4px; }
    .bot { justify-content: flex-start; }
    .bot .bubble { background:#1b2432; color:#e6e6e6; border-bottom-left-radius: 4px; }
    .controls { display:flex; gap:8px; margin-top: 10px; }
    input, select, button, textarea { border-radius:8px; border:1px solid #2a2f3a; background:#151922; color:#e6e6e6; padding:10px; }
    input, textarea { width: 100%; }
    button { cursor:pointer; }
    .row-small { display:flex; gap:8px; margin-top:10px; align-items:center; }
    small { opacity: 0.8; }
  </style>
</head>
<body>
  <header>
    <h1>🌙 Luna Web Chat</h1>
    <small id="status">Status: checking…</small>
  </header>
  <main>
    <div class="row-small">
      <label for="mode">Personality:</label>
      <select id="mode">
        <option value="friendly">friendly</option>
        <option value="teacher">teacher</option>
        <option value="sarcastic">sarcastic</option>
        <option value="professional">professional</option>
      </select>
      <button id="resetBtn">🗑 Reset</button>
    </div>

    <div id="chat"></div>

    <div class="controls">
      <input id="message" placeholder="Type your message and press Enter…" />
      <button id="sendBtn">Send</button>
    </div>

    <div class="row-small">
      <input id="note" placeholder="Add a long-term note (e.g., I like finance topics)" />
      <button id="saveNoteBtn">Save note</button>
    </div>

    <div class="row-small">
      <input type="file" id="fileInput" accept=".txt,application/pdf" />
      <button id="uploadBtn">Upload file</button>
      <small>TXT or PDF. Added to your context.</small>
    </div>
  </main>

  <script>
    const userId = "web_" + Math.random().toString(36).slice(2, 8);
    const chat = document.getElementById("chat");
    const msgInput = document.getElementById("message");
    const modeSel = document.getElementById("mode");
    const statusEl = document.getElementById("status");

    function addRow(text, who="bot") {
      const row = document.createElement("div");
      row.className = "row " + (who === "me" ? "me" : "bot");
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    async function checkStatus() {
      try {
        const res = await fetch("/status");
        const data = await res.json();
        statusEl.textContent = `Status: OpenAI ${data.openai} • Telegram ${data.telegram} • Users ${data.usersTracked}`;
      } catch {
        statusEl.textContent = "Status: unavailable";
      }
    }

    async function send() {
      const text = msgInput.value.trim();
      if (!text) return;
      addRow(text, "me");
      msgInput.value = "";

      const mode = modeSel.value;
      const res = await fetch("/public-chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ userId, message: text, mode })
      });
      const data = await res.json();
      addRow(data.reply || "…");
    }

    async function reset() {
      await fetch("/reset/" + userId, { method: "DELETE" });
      chat.innerHTML = "";
      addRow("✅ Chat memory reset.");
    }

    async function saveNote() {
      const note = document.getElementById("note").value.trim();
      if (!note) return;
      await fetch("/note", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ userId, note })
      });
      document.getElementById("note").value = "";
      addRow("📝 Note saved.");
    }

    async function uploadFile() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append("userId", userId);
      fd.append("file", file);
      const res = await fetch("/upload", { method: "POST", body: fd });
      const data = await res.json();
      if (data.success) addRow(`📄 File added to context (${data.charsAdded} chars).`);
      else addRow("⚠️ Upload failed: " + (data.error || "Unknown"));
    }

    // Events
    document.getElementById("sendBtn").onclick = send;
    document.getElementById("resetBtn").onclick = reset;
    document.getElementById("saveNoteBtn").onclick = saveNote;
    document.getElementById("uploadBtn").onclick = uploadFile;
    msgInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") send(); });

    checkStatus();
    addRow("Hi, I’m Luna. Pick a personality, then say hello!");
  </script>
</body>
</html>
